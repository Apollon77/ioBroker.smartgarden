![Logo](admin/smartgarden.png) 

# ioBroker.smartgarden

![Number of Installations](http://iobroker.live/badges/smartgarden-installed.svg) 
[![NPM version](http://img.shields.io/npm/v/iobroker.smartgarden.svg)](https://www.npmjs.com/package/iobroker.smartgarden)
[![Downloads](https://img.shields.io/npm/dm/iobroker.smartgarden.svg)](https://www.npmjs.com/package/iobroker.smartgarden)

[![NPM](https://nodei.co/npm/iobroker.smartgarden.png?downloads=true)](https://nodei.co/npm/iobroker.smartgarden/)

[![Build Status](https://travis-ci.org/jpgorganizer/ioBroker.smartgarden.svg?branch=master)](https://travis-ci.org/jpgorganizer/ioBroker.smartgarden)


## ioBroker smartgarden adapter for GARDENA smart system

An adapter for Gardena smart system using official GARDENA smart system API and service. 


## Installation

Adapter is available at GitHub under https://github.com/jpgorganizer/ioBroker.smartgarden. An description how to install from GitHub is available [here](https://www.iobroker.net/docu/index-235.htm?page_id=5379&lang=de#3_Adapter_aus_eigener_URL_installieren) (German language).


## Requirements

To use this adapter you need two things:
1. an GARDENA smart system account
1. an GARDENA application key

To get both things please go to https://developer.1689.cloud/docs#/docs/getting-started/

And of course you need a running ioBroker installation. 

## Setup adapter

1. Install the adapter
1. Create an instance of the adapter
1. Edit username and password  in instance configuration
1. Edit application key in instance configuration
1. Verify default values of other settings in instance configuration. For most users the following values will be ok.
    - ping frequence: 150 seconds
    - factor for token validity: 1.001
	- PreDefineStates: (new in v0.4.0): `false` (default), if `true` then all states of the Gardena API are created regardless if they are currently transmitted by Gardena service
    - testVariable: false (just for debugging/development)
    - Loglevel: 3 (default)  [0 = no log, 1 = some logs, 2 = some more logs, 3 = all logs]
	- Authentication host URL: https://api.authentication.husqvarnagroup.dev
	- Webservice Basis-URL: https://api.smart.gardena.dev

Please note that password and application key are encoded and stored within the adapter 
and become just decoded for authentication with the Gardena application host.
  
  
## Datapoints of the adapter
The adapter is designed to monitor and control Gardena smart system devices. For this there
will be one `LOCATION` and many `DEVICE`s. For each `DEVICE` there will be one or more 
`SERVICE_<servicelink_type>_<id>`. Where `<servicelink_type>` is a type description of the device, for example MOWER, POWER_SOCKET, VALVE or VALVE_SET. See description for ServiceLink at 
https://developer.1689.cloud/apis/GARDENA+smart+system+API#/swagger. `<id>` is a Gardena device id used by the API.

Supported devices:
  - mower (MOWER),
  - smart irrigation control (VALVE_SET and VALVE)
  - power socket (POWER_SOCKET)
  - sensor (SENSOR) 
 
### For MOWER
#### Controlling
To control the device use datapoint
- `activity_control_i`

  *This datapoint is generated by the adapter and not by Gardena API.*
  
  Change this datapoint to start the mower. 
  - To start for a defined time set the value to the planned duration in seconds (please use multiples of 60)
  - for automatic operation set string `START_DONT_OVERRIDE`
  - to cancel the current operation and return to charging station use string `PARK_UNTIL_NEXT_TASK`
  - to cancel the current operation, return to charging station and ignore schedule use string `PARK_UNTIL_FURTHER_NOTICE`

#### Monitoring
All other datapoints are just for monitoring and information.

Special datapoints:
- `activity_mowing_i`

  *This datapoint is generated by the adapter and not by Gardena API.*

  This datapoint shows two different states for the mower: 
  - `true`: mowing or 
  - `false`: not mowing. 
  
  Depending on the value of datapoint `activity_value` this datapoint is set.
  
  If `activity_value` is 
    - `OK_CHARGING` The mower has to be mowing but insufficient charge level keeps it in the charging station.
    - `PARKED_TIMER` The mower is parked according to timer, will start again at configured time.
    - `PARKED_PARK_SELECTED` The mower is parked until further notice.
    - `PARKED_AUTOTIMER` The mower skips mowing because of insufficient grass height.
    - `PAUSED` The mower is in a waiting state with hatch closed.
 
  `activity_mowing_i`  is set to `false`.

  If `activity_value` is 
    - `OK_CUTTING` The mower is cutting in AUTO mode (schedule).
    - `OK_CUTTING_TIMER_OVERRIDDEN` The mower is cutting outside schedule.
    - `OK_SEARCHING` The mower is searching for the charging station.
    - `OK_LEAVING` The mower is leaving charging station.
    - `NONE` No activity is happening, perhaps due to an error.
    - all other values
	
  `activity_mowing_i`  is set to `true`.

- `duration_leftover_i`

  *This datapoint is generated by the adapter and not by Gardena API.* 

    The value describes the number of minutes till the mower stops mowing. 
    - An integer, one (`1`) or more.
    - `null` if undefined

- `lastErrorCode_value`

  Please pay special attention to datapoint `lastErrorCode_value`. A description of possible values can be found at https://developer.1689.cloud/apis/GARDENA+smart+system+API#/swagger, see "MowerService - lastErrorCode"

### For VALVE_SET
#### Controlling
To control the device use datapoint
- `stop_all_valves_i`

  *This datapoint is generated by the adapter and not by Gardena API.* 

  Change this datapoint to stop all valves. 
  - To stop all valves immediately use string `STOP_UNTIL_NEXT_TASK`
  
  Note: Do not display the value of this datapoint in your application, as the value is mostly undefined

#### Monitoring  
All other datapoints are just for monitoring and information.

 
### For VALVE
#### Controlling

To control the device use datapoint
- `duration_value`

  Change this datapoint to start the valve. 
  - To start for a defined time  set the value to the value in seconds (please use multiples of 60). 
    
    **Note:** It seems that there is a not documented limitation for this value to a maximum of 3540 seconds (59 minutes). Please report if you see this or other limitations. (at least I didn't see that in documentation)
  - to cancel the current watering and continue with the schedule use string `STOP_UNTIL_NEXT_TASK`
  - to skip automatic operation until specified time, the currently active operation might or might not be cancelled (depends on device model) use string `PAUSE` 
  - to restore automatic operation if it was paused use string `UNPAUSE`
  
#### Monitoring

All other datapoints are just for monitoring and information.

Special datapoint:
- `duration_leftover_i`

  *This datapoint is generated by the adapter and not by Gardena API.*
  
  The value describes the number of minutes till the valve is closed and watering stops. 
    - An integer, one (`1`) or more.
    - `null` if undefined
   


 
### For POWER_SOCKET
#### Controlling
To control the device use datapoint
- `duration_value`

  Change this datapoint to start the power socket. 
  - To start for a defined time  set the value to the value in seconds (please use multiples of 60)
  - To switch on the device forever please use the string `START_OVERRIDE`.
  - To stop the device use `STOP_UNTIL_NEXT_TASK`.

#### Monitoring

Special datapoint:
- `duration_leftover_i`

  *This datapoint is generated by the adapter and not by Gardena API.*
  
  The value describes the number of minutes till the power socket is shut off.  
    - An integer, one (`1`) or more.
    - `null` if undefined
  
All other datapoints are just for monitoring and information.

  
### For SENSOR
#### Controlling
No control functions available.

#### Monitoring
tbd.

Note: not tested 

  
## Known Errors
- the received value for mower datapoint `operationHours_value` is different to that reported in Gardena App. It's currently not clear  which one is correct.


## Note
This is a private project. I am not in any association with Gardena or Husqvarna.

  
## Changelog
### 0.4.0
* (jpgorganizer) 
  - **NOTE**: with this version an additional dependency is necessary at runtime. If it does not get installed together with the installation of this adapter, please install seperately with `npm install https://github.com/jpgorganizer/ioBroker.utils` 
  - **NOTE**: you **must delete all states** of the adapter instance to install this release and please check your application carefully for necessary adjustments regarding type/role changes (see below) 
  - data types of (nearly) all datapoints adjusted for compliance with ioBroker guidance: 
    * states now have special ioBroker type and role instead of former `string`/`text` where applicable, e.g. `number`/`value.battery` for `batteryLevel_value` (Issue https://github.com/jpgorganizer/ioBroker.smartgarden/issues/3)
  - datapoint `activity_value_i` replaced by `activity_mowing_i` with type/role `boolean`/`indicator.working`: `true` means *mowing*, `false` means *not mowing*
  - possibility to pre-define states integrated, see new switch `PreDefine States` in adapter/instance configuration (Issue https://github.com/jpgorganizer/ioBroker.smartgarden/issues/2)
  - states are readonly now; except states for commands (Issue https://github.com/jpgorganizer/ioBroker.smartgarden/issues/4)
  - input field for `useTestVariable` in adapter/instance configuration switched to a *checkbox* (former: *text*); please check your settings
  - error in command  `stop_all_valves_i` in VALVE_SET fixed
  
### 0.3.0
* (jpgorganizer) 
  - create all states read/write 
  - error TypeError: Cannot read property 'val' of null with useTestVariable fixed


### 0.2.0
* (jpgorganizer) 
  - **IMPORTANT** : datapoint for MOWER control (command) changed from  `duration_value` to `activity_control_i`
  - rework leftovertimer 
  - improved error handling
  - improved logging (see  loglevel in adapter configurations)

### 0.0.1
* (jpgorganizer) initial release


## Credits
smartgarden logo: http://www.freepik.com Designed by Freepik


## License
 Copyright (c) 2020 jpgorganizer, https://github.com/jpgorganizer 
 
 smartgarden by jpgorganizer is licensed under a 
 Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License [(CC BY-NC-SA4.0)](https://creativecommons.org/licenses/by-nc-sa/4.0/)
 Based on a work at https://github.com/jpgorganizer/ioBroker.smartgarden.
 

